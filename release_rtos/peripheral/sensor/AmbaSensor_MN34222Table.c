/*-------------------------------------------------------------------------------------------------------------------*\
 *  @FileName       :: AmbaSensor_MN34222Table.c
 *
 *  @Copyright      :: Copyright (C) 2013 Ambarella Corporation. All rights reserved.
 *
 *                     No part of this file may be reproduced, stored in a retrieval system,
 *                     or transmitted, in any form, or by any means, electronic, mechanical, photocopying,
 *                     recording, or otherwise, without the prior consent of Ambarella Corporation.
 *
 *  @Description    :: Control APIs of Panasonic MN34222 CMOS sensor with LVDS interface
\*-------------------------------------------------------------------------------------------------------------------*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "AmbaDataType.h"
#include "AmbaDSP.h"
#include "AmbaSensor.h"
#include "AmbaSensor_MN34222.h"

/*-----------------------------------------------------------------------------------------------*\
 * Sensor Device Information
\*-----------------------------------------------------------------------------------------------*/
const AMBA_SENSOR_DEVICE_INFO_s MN34222DeviceInfo = {
    .UnitCellWidth          = 2.75,
    .UnitCellHeight         = 2.75,
    .NumTotalPixelCols      = 1956,
    .NumTotalPixelRows      = 1108,
    .NumEffectivePixelCols  = 1944,
    .NumEffectivePixelRows  = 1092,
    .MinAnalogGainFactor    = 1.0,
    .MaxAnalogGainFactor    = 32.0,
    .MinDigitalGainFactor   = 1.0,
    .MaxDigitalGainFactor   = 32.0, // 16x for AMBA_SENSOR_MN34222_V1_12_1944X1092_30P_HDR

    .FrameRateCtrlInfo = {
        .CommunicationTime      = AMBA_SENSOR_COMMUNICATION_AT_NON_VBLANK,
        .FirstReflectedFrame    = 2,
        .FirstBadFrame          = 0,
        .NumBadFrames           = 0
    },
    .ShutterSpeedCtrlInfo = {
        .CommunicationTime      = AMBA_SENSOR_COMMUNICATION_AT_NON_VBLANK,
        .FirstReflectedFrame    = 2,
        .FirstBadFrame          = 0,
        .NumBadFrames           = 0
    },
    .AnalogGainCtrlInfo = {
        .CommunicationTime      = AMBA_SENSOR_COMMUNICATION_AT_NON_VBLANK,
        .FirstReflectedFrame    = 1,
        .FirstBadFrame          = 0,
        .NumBadFrames           = 0
    },
    .DigitalGainCtrlInfo = {
        .CommunicationTime      = AMBA_SENSOR_COMMUNICATION_AT_NON_VBLANK,
        .FirstReflectedFrame    = 1,
        .FirstBadFrame          = 0,
        .NumBadFrames           = 0
    },

    .HdrIsSupport = 1
};

/*-----------------------------------------------------------------------------------------------*\
 * Sensor register settings of each readout modes
\*-----------------------------------------------------------------------------------------------*/
MN34222_REG_s MN34222RegTable[MN34222_NUM_READOUT_MODE_REG] = {
    {0x300E, {0x0001, 0x0001, 0x0001, 0x0001, 0x0001}},
    {0x300F, {0x0000, 0x0000, 0x0000, 0x0000, 0x0000}},
    {0x0307, {0x0021, 0x0021, 0x0021, 0x002C, 0x002C}},
    {0x3000, {0x0000, 0x0000, 0x0000, 0x0000, 0x0000}},
    {0x3001, {0x0003, 0x0003, 0x0003, 0x0003, 0x0003}},
    {0x0112, {0x000C, 0x000C, 0x000C, 0x000C, 0x000C}},
    {0x0113, {0x000C, 0x000C, 0x000C, 0x000C, 0x000C}},
    {0x300B, {0x0000, 0x0000, 0x0000, 0x0000, 0x0000}},  // Sensor master mode (0x0080: Slave mode)
    {0x3004, {0x0003, 0x0003, 0x0003, 0x0003, 0x0004}},
    {0x3005, {0x0064, 0x0064, 0x0064, 0x0067, 0x0067}},
    {0x3007, {0x0010, 0x0010, 0x0014, 0x0010, 0x0010}},
    {0x3008, {0x0091, 0x0091, 0x0091, 0x0091, 0x0001}},
    {0x3018, {0x0043, 0x0043, 0x0043, 0x0043, 0x0043}},
    {0x3019, {0x0010, 0x0010, 0x0010, 0x0010, 0x0010}},
    {0x301A, {0x00B9, 0x00B9, 0x00B9, 0x00B9, 0x00B9}},
    {0x3000, {0x0000, 0x0000, 0x0000, 0x0000, 0x0000}},
    {0x3001, {0x0053, 0x0053, 0x0053, 0x0053, 0x0053}},
    {0x300E, {0x0000, 0x0000, 0x0000, 0x0000, 0x0000}},
    {0x300F, {0x0000, 0x0000, 0x0000, 0x0000, 0x0000}},
    {0x0202, {0x0004, 0x0004, 0x0004, 0x0004, 0x0004}},  // exposure time of long frame (h)
    {0x0203, {0x0063, 0x0063, 0x0063, 0x004F, 0x004F}},  // exposure time of long frame (l)
    {0x020F, {0x0000, 0x0000, 0x0000, 0x003F, 0x0000}},
    {0x0211, {0x0000, 0x0000, 0x0000, 0x003F, 0x0000}},
    {0x0213, {0x0000, 0x0000, 0x0000, 0x003F, 0x0000}},
    {0x0215, {0x0000, 0x0000, 0x0000, 0x003F, 0x0000}},
    {0x0340, {0x0004, 0x0008, 0x0004, 0x0005, 0x0004}},  // frame length line (h)
    {0x0341, {0x0065, 0x00CA, 0x0065, 0x00DC, 0x0065}},  // frame length line (l)
    {0x0342, {0x0008, 0x0008, 0x0008, 0x0011, 0x0011}},  // pck (h)
    {0x0343, {0x0098, 0x0098, 0x0098, 0x0030, 0x0030}},  // pck (l)
    {0x3036, {0x0000, 0x0000, 0x0000, 0x0000, 0x0000}},
    {0x3039, {0x002E, 0x002E, 0x002E, 0x002E, 0x002E}},
    {0x3041, {0x002C, 0x002C, 0x002C, 0x002C, 0x0012}},
    {0x3058, {0x000F, 0x000F, 0x000F, 0x000F, 0x0003}},
    {0x305D, {0x0040, 0x0040, 0x0040, 0x0042, 0x0042}},
    {0x3066, {0x000A, 0x000A, 0x000A, 0x000A, 0x000A}},
    {0x3067, {0x00B0, 0x00B0, 0x00B0, 0x00B0, 0x00B0}},
    {0x3068, {0x0008, 0x0008, 0x0008, 0x0008, 0x0008}},
    {0x3069, {0x0000, 0x0000, 0x0000, 0x0000, 0x0000}},
    {0x306A, {0x000B, 0x000B, 0x000B, 0x000B, 0x000B}},
    {0x306B, {0x0060, 0x0060, 0x0060, 0x0060, 0x0060}},
    {0x306C, {0x0009, 0x0009, 0x0009, 0x0009, 0x0009}},
    {0x306D, {0x00D0, 0x00D0, 0x00D0, 0x00D0, 0x00D0}},
    {0x3074, {0x0001, 0x0001, 0x0001, 0x0001, 0x0001}},
    {0x3078, {0x0000, 0x0000, 0x0000, 0x0001, 0x0001}},
    {0x306E, {0x000C, 0x000C, 0x000C, 0x000A, 0x0009}},
    {0x306F, {0x0000, 0x0000, 0x0000, 0x0000, 0x0000}},
    {0x3098, {0x0000, 0x0000, 0x0000, 0x0004, 0x0000}},
    {0x3099, {0x0000, 0x0000, 0x0000, 0x0000, 0x0040}},
    {0x309A, {0x0001, 0x0001, 0x0001, 0x0020, 0x0010}},
    {0x3101, {0x0000, 0x0000, 0x0000, 0x0001, 0x0001}},
    {0x3104, {0x0004, 0x0004, 0x0004, 0x0004, 0x0004}},
    {0x3106, {0x0000, 0x0000, 0x0000, 0x0000, 0x0000}},
    {0x3107, {0x00C0, 0x00C0, 0x00C0, 0x0080, 0x0040}},
    {0x310B, {0x0000, 0x0000, 0x0000, 0x003F, 0x0000}},
    {0x310D, {0x0000, 0x0000, 0x0000, 0x003F, 0x0000}},
    {0x310F, {0x0000, 0x0000, 0x0000, 0x003F, 0x0000}},
    {0x3111, {0x0000, 0x0000, 0x0000, 0x003F, 0x0000}},
    {0x3113, {0x0000, 0x0000, 0x0000, 0x003F, 0x0000}},
    {0x3115, {0x0000, 0x0000, 0x0000, 0x003F, 0x0000}},
    {0x3117, {0x0000, 0x0000, 0x0000, 0x003F, 0x0000}},
    {0x3119, {0x0000, 0x0000, 0x0000, 0x003F, 0x0000}},
    {0x311B, {0x0000, 0x0000, 0x0000, 0x003F, 0x0000}},
    {0x311D, {0x0000, 0x0000, 0x0000, 0x003F, 0x0000}},
    {0x311F, {0x0000, 0x0000, 0x0000, 0x003F, 0x0000}},
    {0x3121, {0x0000, 0x0000, 0x0000, 0x003F, 0x0000}},
    {0x312A, {0x0000, 0x0000, 0x0000, 0x0001, 0x0000}},  // exposure time of short frame (h)
    {0x312B, {0x0000, 0x0000, 0x0000, 0x0088, 0x0011}},  // exposure time of short frame (l)
    {0x312D, {0x0000, 0x0000, 0x0000, 0x0020, 0x0020}},
    {0x312F, {0x0000, 0x0000, 0x0000, 0x0020, 0x0020}},
    {0x3141, {0x0040, 0x0040, 0x0040, 0x0040, 0x0070}},
    {0x3143, {0x0002, 0x0002, 0x0002, 0x0003, 0x0001}},
    {0x3144, {0x0002, 0x0002, 0x0002, 0x0004, 0x0003}},
    {0x3145, {0x0002, 0x0002, 0x0002, 0x0003, 0x0002}},
    {0x3146, {0x0000, 0x0000, 0x0000, 0x0005, 0x0005}},
    {0x3147, {0x0002, 0x0002, 0x0002, 0x0005, 0x0000}},
    {0x3148, {0x0002, 0x0002, 0x0002, 0x0002, 0x0000}},
    {0x3149, {0x0002, 0x0002, 0x0002, 0x0002, 0x0000}},
    {0x314A, {0x0001, 0x0001, 0x0001, 0x0005, 0x0003}},
    {0x314B, {0x0002, 0x0002, 0x0002, 0x0003, 0x0001}},
    {0x314C, {0x0002, 0x0002, 0x0002, 0x0006, 0x0001}},
    {0x314D, {0x0002, 0x0002, 0x0002, 0x0007, 0x0001}},
    {0x314E, {0x0001, 0x0001, 0x0001, 0x0006, 0x0002}},
    {0x314F, {0x0002, 0x0002, 0x0002, 0x0006, 0x0002}},
    {0x3150, {0x0002, 0x0002, 0x0002, 0x0007, 0x0002}},
    {0x3152, {0x0004, 0x0004, 0x0004, 0x0006, 0x0001}},
    {0x3153, {0x00E3, 0x00E3, 0x00E3, 0x0007, 0x0007}},
    {0x3155, {0x00CA, 0x00CA, 0x00CA, 0x00CA, 0x0011}},
    {0x3157, {0x00CA, 0x00CA, 0x00CA, 0x00CA, 0x0030}},
    {0x3159, {0x00CA, 0x00CA, 0x00CA, 0x00CA, 0x0033}},
    {0x315B, {0x00CA, 0x00CA, 0x00CA, 0x00CA, 0x0036}},
    {0x315D, {0x00CA, 0x00CA, 0x00CA, 0x005D, 0x0035}},
    {0x315F, {0x00CA, 0x00CA, 0x00CA, 0x005F, 0x003C}},
    {0x3161, {0x00CA, 0x00CA, 0x00CA, 0x005F, 0x003F}},
    {0x3163, {0x00CA, 0x00CA, 0x00CA, 0x005F, 0x003A}},
    {0x3165, {0x00CA, 0x00CA, 0x00CA, 0x005F, 0x0039}},
    {0x3167, {0x00CA, 0x00CA, 0x00CA, 0x0059, 0x0028}},
    {0x3169, {0x00CA, 0x00CA, 0x00CA, 0x0059, 0x002B}},
    {0x316B, {0x00CA, 0x00CA, 0x00CA, 0x0059, 0x002E}},
    {0x316D, {0x00CA, 0x00CA, 0x00CA, 0x0046, 0x002D}},
    {0x316F, {0x00C6, 0x00C6, 0x00C6, 0x0043, 0x0022}},
    {0x3171, {0x00CA, 0x00CA, 0x00CA, 0x00C6, 0x0022}},
    {0x3173, {0x00CA, 0x00CA, 0x00CA, 0x00C6, 0x0061}},
    {0x3175, {0x0080, 0x0080, 0x0080, 0x0080, 0x0080}},
    {0x318E, {0x0020, 0x0020, 0x0020, 0x0020, 0x0020}},
    {0x318F, {0x0070, 0x0070, 0x0070, 0x0070, 0x0070}},
    {0x3196, {0x0008, 0x0008, 0x0008, 0x0008, 0x0008}},
    {0x31FC, {0x0002, 0x0002, 0x0002, 0x0002, 0x0003}},
    {0x31FE, {0x0007, 0x0007, 0x0007, 0x0007, 0x0006}},
    {0x323C, {0x0071, 0x0071, 0x0071, 0x0070, 0x0070}},
    {0x323E, {0x0001, 0x0001, 0x0001, 0x0000, 0x0000}},
    {0x3243, {0x00D7, 0x00D7, 0x00D7, 0x00D1, 0x0075}},
    {0x3246, {0x0001, 0x0001, 0x0001, 0x0000, 0x0000}},
    {0x3247, {0x0079, 0x0079, 0x0038, 0x008C, 0x00C9}},
    {0x3248, {0x0000, 0x0000, 0x0003, 0x0000, 0x0000}},
    {0x3249, {0x0000, 0x0000, 0x00E2, 0x0000, 0x0000}},
    {0x324A, {0x0030, 0x0030, 0x0030, 0x0030, 0x0030}},
    {0x324B, {0x0018, 0x0018, 0x0018, 0x0018, 0x001B}},
    {0x324C, {0x0002, 0x0002, 0x0002, 0x0002, 0x0002}},
    {0x3253, {0x00DE, 0x00DE, 0x00DE, 0x00D4, 0x007B}},
    {0x3256, {0x0011, 0x0011, 0x0011, 0x0011, 0x0032}},
    {0x3258, {0x0001, 0x0001, 0x0001, 0x0000, 0x0000}},
    {0x3259, {0x0049, 0x0049, 0x0068, 0x00BC, 0x005C}},
    {0x325A, {0x0039, 0x0039, 0x0039, 0x0039, 0x0014}},
    {0x3272, {0x0046, 0x0046, 0x0046, 0x0055, 0x000C}},
    {0x3280, {0x0030, 0x0030, 0x0030, 0x0030, 0x0030}},
    {0x3282, {0x000E, 0x000E, 0x000E, 0x000E, 0x0007}},
    {0x3285, {0x001B, 0x001B, 0x001B, 0x001B, 0x0019}},
    {0x3288, {0x0001, 0x0001, 0x0001, 0x0001, 0x0000}},
    {0x3289, {0x0000, 0x0000, 0x0000, 0x0000, 0x0040}},
    {0x330E, {0x0005, 0x0005, 0x0005, 0x0005, 0x0005}},
    {0x3310, {0x0002, 0x0002, 0x0002, 0x0002, 0x0002}},
    {0x3315, {0x001F, 0x001F, 0x001F, 0x001F, 0x001F}},
    {0x331A, {0x0002, 0x0002, 0x0002, 0x0002, 0x0003}},
    {0x331B, {0x0002, 0x0002, 0x0002, 0x0002, 0x0003}},
    {0x332C, {0x0002, 0x0002, 0x0002, 0x0002, 0x0000}},
    {0x3339, {0x0002, 0x0002, 0x0002, 0x0002, 0x0003}},
    {0x336B, {0x0003, 0x0003, 0x0003, 0x0003, 0x0002}},
    {0x339F, {0x0003, 0x0003, 0x0003, 0x0003, 0x0001}},
    {0x33A2, {0x0003, 0x0003, 0x0003, 0x0003, 0x0001}},
    {0x33A3, {0x0003, 0x0003, 0x0003, 0x0003, 0x0001}},
    {0x3000, {0x0000, 0x0000, 0x0000, 0x0000, 0x0000}},
    {0x3001, {0x00D3, 0x00D3, 0x00D3, 0x00D3, 0x00D3}},
    {0x0100, {0x0001, 0x0001, 0x0001, 0x0001, 0x0001}},
    {0x0101, {0x0000, 0x0000, 0x0000, 0x0000, 0x0000}},
};

const AMBA_SENSOR_INPUT_INFO_s MN34222InputInfo[] = {
    {{ 0, 0, 1956, 1108}, {AMBA_SENSOR_SUBSAMPLE_TYPE_NORMAL, 1, 1}, {AMBA_SENSOR_SUBSAMPLE_TYPE_NORMAL, 1, 1}},  /* Input Mode 0 */
};

const AMBA_SENSOR_OUTPUT_INFO_s MN34222OutputInfo[] = {
    { 445500000, 4, 12, AMBA_DSP_BAYER_GR, {AMBA_DSP_PHASE_SHIFT_MODE_0, AMBA_DSP_PHASE_SHIFT_MODE_0}, 1956, 1108, { 4, 16, 1944, 1092}, { 4, 2, 1944, 10}},  /* Output Mode 0      */
    { 222000000, 4, 12, AMBA_DSP_BAYER_GR, {AMBA_DSP_PHASE_SHIFT_MODE_0, AMBA_DSP_PHASE_SHIFT_MODE_0}, 1956, 1108, { 4, 16, 1944, 1092}, { 4, 2, 1944, 10}},  /* Output Mode 1      */
    { 445500000, 4, 12, AMBA_DSP_BAYER_GR, {AMBA_DSP_PHASE_SHIFT_MODE_0, AMBA_DSP_PHASE_SHIFT_MODE_0}, 1956, 2999, { 0,  3, 1956, 2996},               {0}},  /* Output Mode 2 (HDR) */
    { 594000000, 6, 12, AMBA_DSP_BAYER_GR, {AMBA_DSP_PHASE_SHIFT_MODE_0, AMBA_DSP_PHASE_SHIFT_MODE_0}, 1956, 2249, { 0,  3, 1956, 2246},               {0}},  /* Output Mode 3 (HDR) */
};

const MN34222_MODE_INFO_s MN34222ModeInfoList[AMBA_SENSOR_MN34222_NUM_MODE] = {
    {       MN34222_S1_12_1944X1092_60P, MN34222_INPUT_MODE_0, MN34222_OUTPUT_MODE_0,  {26973027, 400, 1, 1125, { .Interlace = 0, .TimeScale =  60000, .NumUnitsInTick = 1001 }}, MN34222_HDR_MODE_0},  /* Mode 0     */
    {MN34222_S1_12_1944X1092_60P_TO_30P, MN34222_INPUT_MODE_0, MN34222_OUTPUT_MODE_0,  {26973027, 400, 1, 2250, { .Interlace = 0, .TimeScale =  30000, .NumUnitsInTick = 1001 }}, MN34222_HDR_MODE_0},  /* Mode 1     */
    {       MN34222_S1_12_1944X1092_30P, MN34222_INPUT_MODE_0, MN34222_OUTPUT_MODE_1,  {26973027, 800, 1, 1125, { .Interlace = 0, .TimeScale =  30000, .NumUnitsInTick = 1001 }}, MN34222_HDR_MODE_0},  /* Mode 2     */
    {   MN34222_S1_12_1944X1092_30P_HDR, MN34222_INPUT_MODE_0, MN34222_OUTPUT_MODE_2,  {26973027, 300, 1, 3000, { .Interlace = 0, .TimeScale =  30000, .NumUnitsInTick = 1001 }}, MN34222_HDR_MODE_1},  /* Mode 3 (HDR) */
    {   MN34222_S1_12_1944X1092_60P_HDR, MN34222_INPUT_MODE_0, MN34222_OUTPUT_MODE_3,  {26973027, 200, 1, 2250, { .Interlace = 0, .TimeScale =  60000, .NumUnitsInTick = 1001 }}, MN34222_HDR_MODE_2},  /* Mode 4 (HDR) */
};

const AMBA_SENSOR_HDR_INFO_s MN34222HdrInfo[MN34222_NUM_HDR_MODE] = {
    [MN34222_HDR_MODE_1] = {
        .HdrType = AMBA_SENSOR_HDR_TYPE_MULTI_SLICE,
        .ActiveChannels = 2,
        .ChannelInfo = {
            [0] = {
                .EffectiveArea = { 4, 14, 1944, 1092},
                .OpticalBlackPixels = { 4, 0, 1944, 10},
                .ShutterSpeedCtrlInfo = {AMBA_SENSOR_COMMUNICATION_AT_NON_VBLANK, 2, 0, 0},
                .OutputFormatCtrlInfo = {AMBA_SENSOR_COMMUNICATION_AT_NON_VBLANK, 1, 0, 0},
                . MaxExposureLine = 2540, /* 1 exposure line = 2 row time in HDR mode */
                . MinExposureLine = 2,
            },
            [1] = {
                .EffectiveArea = { 1960, 408, 1944, 1092},
                .OpticalBlackPixels = { 1960, 394, 1944, 10},
                .ShutterSpeedCtrlInfo = {AMBA_SENSOR_COMMUNICATION_AT_NON_VBLANK, 1, 0, 0},
                .OutputFormatCtrlInfo = {AMBA_SENSOR_COMMUNICATION_AT_NON_VBLANK, 1, 0, 0},
                . MaxExposureLine = 450, /* 1 exposure line = 2 row time in HDR mode */
                . MinExposureLine = 2,
            },
        },
    },
    [MN34222_HDR_MODE_2] = {
        .HdrType = AMBA_SENSOR_HDR_TYPE_MULTI_SLICE,
        .ActiveChannels = 2,
        .ChannelInfo = {
            [0] = {
                .EffectiveArea = { 4, 14, 1944, 1092},
                .OpticalBlackPixels = { 4, 0, 1944, 10},
                .ShutterSpeedCtrlInfo = {AMBA_SENSOR_COMMUNICATION_AT_NON_VBLANK, 2, 0, 0},
                .OutputFormatCtrlInfo = {AMBA_SENSOR_COMMUNICATION_AT_NON_VBLANK, 1, 0, 0},
                . MaxExposureLine = 2206, /* 1 exposure line = 2 row time in HDR mode */
                . MinExposureLine = 2,
            },
            [1] = {
                .EffectiveArea = { 1960, 33, 1944, 1092},
                .OpticalBlackPixels = { 1960, 19, 1944, 10},
                .ShutterSpeedCtrlInfo = {AMBA_SENSOR_COMMUNICATION_AT_NON_VBLANK, 1, 0, 0},
                .OutputFormatCtrlInfo = {AMBA_SENSOR_COMMUNICATION_AT_NON_VBLANK, 1, 0, 0},
                . MaxExposureLine = 34, /* 1 exposure line = 2 row time in HDR mode */
                . MinExposureLine = 2,
            },
        },
    },
};
